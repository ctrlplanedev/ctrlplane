// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: computed_resources.sql

package db

import (
	"context"

	"github.com/google/uuid"
)

const setComputedDeploymentResources = `-- name: SetComputedDeploymentResources :exec
WITH current AS (
    SELECT unnest($2::uuid[]) AS resource_id
),
deleted AS (
    DELETE FROM computed_deployment_resource
    WHERE deployment_id = $1
      AND resource_id NOT IN (SELECT resource_id FROM current)
)
INSERT INTO computed_deployment_resource (deployment_id, resource_id, last_evaluated_at)
SELECT $1, resource_id, NOW()
FROM current
ON CONFLICT (deployment_id, resource_id) DO UPDATE
SET last_evaluated_at = NOW()
`

type SetComputedDeploymentResourcesParams struct {
	DeploymentID uuid.UUID
	ResourceIds  []uuid.UUID
}

// Replaces the full set of computed resources for a deployment.
// Deletes stale rows and upserts the current set with last_evaluated_at = NOW().
func (q *Queries) SetComputedDeploymentResources(ctx context.Context, arg SetComputedDeploymentResourcesParams) error {
	_, err := q.db.Exec(ctx, setComputedDeploymentResources, arg.DeploymentID, arg.ResourceIds)
	return err
}

const setComputedEnvironmentResources = `-- name: SetComputedEnvironmentResources :exec
WITH current AS (
    SELECT unnest($2::uuid[]) AS resource_id
),
deleted AS (
    DELETE FROM computed_environment_resource
    WHERE environment_id = $1
      AND resource_id NOT IN (SELECT resource_id FROM current)
)
INSERT INTO computed_environment_resource (environment_id, resource_id, last_evaluated_at)
SELECT $1, resource_id, NOW()
FROM current
ON CONFLICT (environment_id, resource_id) DO UPDATE
SET last_evaluated_at = NOW()
`

type SetComputedEnvironmentResourcesParams struct {
	EnvironmentID uuid.UUID
	ResourceIds   []uuid.UUID
}

// Replaces the full set of computed resources for an environment.
// Deletes stale rows and upserts the current set with last_evaluated_at = NOW().
func (q *Queries) SetComputedEnvironmentResources(ctx context.Context, arg SetComputedEnvironmentResourcesParams) error {
	_, err := q.db.Exec(ctx, setComputedEnvironmentResources, arg.EnvironmentID, arg.ResourceIds)
	return err
}
