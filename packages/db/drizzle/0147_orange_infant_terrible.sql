CREATE TABLE "reconcile_work_payload" (
	"id" bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY (sequence name "reconcile_work_payload_id_seq" INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START WITH 1 CACHE 1),
	"scope_ref" bigint NOT NULL,
	"payload_type" text DEFAULT '' NOT NULL,
	"payload_key" text DEFAULT '' NOT NULL,
	"payload" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"attempt_count" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"created_at" timestamp with time zone DEFAULT now() NOT NULL,
	"updated_at" timestamp with time zone DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "reconcile_work_scope" (
	"id" bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY (sequence name "reconcile_work_scope_id_seq" INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START WITH 1 CACHE 1),
	"workspace_id" uuid NOT NULL,
	"kind" text NOT NULL,
	"scope_type" text DEFAULT '' NOT NULL,
	"scope_id" text DEFAULT '' NOT NULL,
	"event_ts" timestamp with time zone DEFAULT now() NOT NULL,
	"priority" smallint DEFAULT 100 NOT NULL,
	"not_before" timestamp with time zone DEFAULT now() NOT NULL,
	"claimed_by" text,
	"claimed_until" timestamp with time zone,
	"created_at" timestamp with time zone DEFAULT now() NOT NULL,
	"updated_at" timestamp with time zone DEFAULT now() NOT NULL
);
--> statement-breakpoint
ALTER TABLE "reconcile_work_payload" ADD CONSTRAINT "reconcile_work_payload_scope_ref_reconcile_work_scope_id_fk" FOREIGN KEY ("scope_ref") REFERENCES "public"."reconcile_work_scope"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
CREATE UNIQUE INDEX "reconcile_work_payload_scope_ref_payload_type_payload_key_index" ON "reconcile_work_payload" USING btree ("scope_ref","payload_type","payload_key");--> statement-breakpoint
CREATE INDEX "reconcile_work_payload_scope_ref_index" ON "reconcile_work_payload" USING btree ("scope_ref");--> statement-breakpoint
CREATE UNIQUE INDEX "reconcile_work_scope_workspace_id_kind_scope_type_scope_id_index" ON "reconcile_work_scope" USING btree ("workspace_id","kind","scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "reconcile_work_scope_kind_not_before_priority_event_ts_claimed_until_index" ON "reconcile_work_scope" USING btree ("kind","not_before","priority","event_ts","claimed_until");